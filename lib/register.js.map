{"version":3,"sources":["../src/register.js"],"names":["query","parse","window","location","search","phase","selectKind","selectStory","searchScreenshotWrappersByStory","kind","story","api","channel","inited","mounted","Promise","resolve","onInit","context","push","onMount","length","onResolve","onFinishMount","contexts","removeListener","COMPONENT_INIT","COMPONENT_MOUNT","COMPONENT_FINISH_MOUNT","on","searchTargetStories","reject","once","stories","storiesPlainList","group","map","cur","then","results","COMPONENT_ERROR","register","name","getChannel","PREPARE","CAPTURE","setScreenshotStories","COMPONENT_READY","readyComponentScreenshot","Error","failureScreenshot"],"mappings":"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","file":"register.js","sourcesContent":["import 'babel-polyfill';\nimport { getStorybook } from '@storybook/react'; // eslint-disable-line\nimport { flattenDeep } from 'lodash';\nimport { compose, flattenDepth, map } from 'lodash/fp';\nimport addons from '@storybook/addons';\nimport qs from 'query-string';\nimport {\n  PhaseTypes,\n  EventTypes,\n} from './constants';\nimport { promiseChain } from './internal/utils';\nimport pkg from '../package.json';\n\n\nconst query = qs.parse(window.location.search);\nconst phase = query['chrome-screenshot'];\nconst selectKind = query.selectKind;\nconst selectStory = query.selectStory;\n\nconst searchScreenshotWrappersByStory = (kind, story, api, channel) => {\n  const inited = [];\n  const mounted = [];\n\n  // One story can have several usage of withScreenshot.\n  // Using the events from teh ScreenshotWrapper we try to know about the wrappers\n  // events are firing in this sequence. init, mount\n  // If story doesn't have any withScreenshot wrappers, we handle it with FINISH_MOUNT event.\n  // initScreenshot decorator must be added before the gloabl withScreenshot,\n  // so the mount event of the wrapper element in initScreenshot will be fired after\n  // the all mount events of the withScreenthot HOC\n\n  // Why we use 2 kind of events: init and mount?\n  // we use 2 events, init and mount, because in this way\n  // we can recognize when all wrappers are mounted.\n  // Init events always fire before a mount events.\n  // so when we handle first mount event we know the total count of the wrappers.\n\n  return new Promise((resolve) => {\n    function onInit(context) {\n      if (context.kind !== kind || context.story !== story) return;\n      inited.push(context);\n    }\n    function onMount(context) {\n      if (context.kind !== kind || context.story !== story) return;\n      mounted.push(context);\n      if (mounted.length === inited.length) {\n        onResolve(mounted); // eslint-disable-line\n      }\n    }\n    function onFinishMount(context) {\n      if (context.kind !== kind || context.story !== story) return;\n      if (inited.length === 0) onResolve([]); // eslint-disable-line\n    }\n    function onResolve(contexts) {\n      resolve(contexts);\n      channel.removeListener(EventTypes.COMPONENT_INIT, onInit);\n      channel.removeListener(EventTypes.COMPONENT_MOUNT, onMount);\n      channel.removeListener(EventTypes.COMPONENT_FINISH_MOUNT, onFinishMount);\n    }\n    channel.on(EventTypes.COMPONENT_INIT, onInit);\n    channel.on(EventTypes.COMPONENT_MOUNT, onMount);\n    channel.on(EventTypes.COMPONENT_FINISH_MOUNT, onFinishMount);\n\n    api.selectStory(kind, story);\n  });\n};\n\nconst searchTargetStories = (channel, api) => new Promise((resolve, reject) => {\n  channel.once('setStories', ({ stories }) => {\n    const storiesPlainList = compose(\n      flattenDepth(2),\n      map(group => group.stories.map(story => ({ kind: group.kind, story }))) // eslint-disable-line\n    )(stories);\n\n    promiseChain(\n      storiesPlainList,\n      cur => searchScreenshotWrappersByStory(cur.kind, cur.story, api, channel) // eslint-disable-line\n    ).then((results) => {\n      const contexts = flattenDeep(results);\n      resolve(contexts);\n    }, reject);\n\n    channel.on(EventTypes.COMPONENT_ERROR, reject);\n  });\n});\n\n\naddons.register(pkg.name, async (api) => {\n  if (!phase) {\n    return;\n  }\n\n  try {\n    const channel = addons.getChannel();\n\n    switch (phase) {\n      case PhaseTypes.PREPARE:\n        await window.setScreenshotStories(await searchTargetStories(channel, api));\n        return;\n\n      case PhaseTypes.CAPTURE:\n        channel.on(EventTypes.COMPONENT_READY, ({ kind, story }) => {\n          if (selectKind === kind && selectStory === story) {\n            window.readyComponentScreenshot();\n          }\n        });\n        api.selectStory(selectKind, selectStory);\n        break;\n\n      default: throw new Error(`An unknown phase called \"${phase}\" is being executed.`);\n    }\n  } catch (e) {\n    window.failureScreenshot(e);\n  }\n});\n"]}